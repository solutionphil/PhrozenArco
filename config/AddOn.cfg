
[respond]
[exclude_object]

[output_pin beeper]
pin: PB2
value: 0
shutdown_value: 0
pwm: True
cycle_time: 0.005 ; Default beeper tone in kHz. 1 / 0.0005 = 1000Hz (2kHz)

[delayed_gcode startup_beep]
initial_duration: 1
gcode:
  SET_PIN PIN=beeper VALUE=0.2
  G4 P25
  SET_PIN PIN=beeper VALUE=0
  G4 P100  
  SET_PIN PIN=beeper VALUE=0.1
  G4 P50
  SET_PIN PIN=beeper VALUE=0
  
[temperature_fan board_fan]
pin: PA2
sensor_type: temperature_host
min_temp: 0
max_temp: 100
target_temp: 50.0
max_speed: 1.0
min_speed: 0.4
control: pid
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
gcode_id: PI

[screws_tilt_adjust]
screw1:
    30, 30
screw1_name:
  bottom_left
screw2:
    270, 30
screw2_name:
  bottom_right
screw3:
  270, 270
screw3_name:
  top_right
screw4:
  30, 270
screw4_name:
  top_left
speed: 50
horizontal_move_z: 20
screw_thread: CCW-M4

[z_tilt]
z_positions:
  365, 150
  -45, 150
points:
  270, 150
  30, 150
speed: 100
horizontal_move_z: 30
retries: 3
retry_tolerance: 0.01

# Wrap SCREWS_TILT_CALCULATE to home first
[gcode_macro SCREWS_TILT_CALCULATE]
rename_existing: _SCREWS_TILT_CALCULATE
gcode:
    G28
  _SCREWS_TILT_CALCULATE

# Wrap Z_TILT_ADJUST to home first
[gcode_macro Z_TILT_ADJUST]
rename_existing: _Z_TILT_ADJUST
gcode:
    G28
  _Z_TILT_ADJUST  

[gcode_macro BED_MESH_CALIBRATE_CUSTOM]
gcode:
    {% set x_size = params.MESH_MAX_X|float - params.MESH_MIN_X|float %}
    {% set y_size = params.MESH_MAX_Y|float - params.MESH_MIN_Y|float %}
    {% set max_size = x_size if x_size > y_size else y_size %}

    {% if max_size <= 40 %}
        {% set probe_count = "3,3" %}
    {% elif max_size <= 150 %}
        {% set probe_count = "4,4" %}
    {% else %}
        {% set probe_count = "5,5" %}
    {% endif %}

    BED_MESH_CLEAR
    BED_MESH_CALIBRATE PROFILE=phrozen mesh_min={params.MESH_MIN_X},{params.MESH_MIN_Y} mesh_max={params.MESH_MAX_X},{params.MESH_MAX_Y} probe_count={probe_count} algorithm=bicubic

[gcode_macro TOGGLE_LIGHT]
variable_toggle_state: 0
gcode:
  {% if printer["gcode_macro TOGGLE_LIGHT"].toggle_state == 0 %}
    SET_GCODE_VARIABLE MACRO=TOGGLE_LIGHT VARIABLE=toggle_state VALUE=1
    P0 LED_SetState=1
  {% else %}
    SET_GCODE_VARIABLE MACRO=TOGGLE_LIGHT VARIABLE=toggle_state VALUE=0
    P0 LED_SetState=0
  {% endif %}

  # === Filament Change (two pauses; no extra check pause) ===
[gcode_macro M600]
description: Filament change with retract -> pause, then load -> pause, then purge & resume
variable_filament_change: 0        # 0 = idle, 1 = in M600 flow
variable_stage: 0                  # 0 = waiting to load, 1 = loaded & waiting second RESUME
variable_unload_length: 45         # mm retract to unload
variable_unload_speed: 600         # mm/min
variable_load_length: 50           # mm load after first RESUME
variable_load_speed: 300           # mm/min
variable_antiooze: 2.0             # mm to retract
variable_antiooze_speed: 600       # mm/min
gcode:
    # Enter M600 flow and remember print state
    SET_GCODE_VARIABLE MACRO=M600 VARIABLE=filament_change VALUE=1
    SET_GCODE_VARIABLE MACRO=M600 VARIABLE=stage VALUE=0
    SAVE_GCODE_STATE NAME=M600_state

    # Record temps/fans and park at your cut-waiting area
    PG103
    PG104
    PRZ_WAITINGAREA

    # Unload (retract), then pause for swap
    RESPOND PREFIX="M600" MSG="Retracting… swap filament, then press RESUME to load."
    G91
    G1 E-{unload_length} F{unload_speed}
    G90
    PAUSE


# === RESUME: handle M600 stages, otherwise behave normally ===
[gcode_macro RESUME]
rename_existing: BASE_RESUMEPRINT
gcode:
    {% set changing = printer["gcode_macro M600"].filament_change|int %}
    {% set stage    = printer["gcode_macro M600"].stage|int %}

    {% if changing == 1 and stage == 0 %}
        # First RESUME after M600: heat, load and retract, then pause once more
        RESPOND PREFIX="M600" MSG="Heating and loading… press RESUME again to continue."
        PG109
        G91
        G1 E{printer["gcode_macro M600"].load_length} F{printer["gcode_macro M600"].load_speed}
        G1 -E{printer["gcode_macro M600"].antiooze}F{printer["gcode_macro M600"].antiooze_speed}
        G90
        SET_GCODE_VARIABLE MACRO=M600 VARIABLE=stage VALUE=1
        PAUSE
        # stay paused; do NOT fall through

    {% elif changing == 1 and stage == 1 %}
        # Second RESUME: wipe, clear flag, restore state, and continue — no more pauses
        RESPOND PREFIX="M600" MSG="Press resume…"
        PRZ_WAITINGAREA
        PRZ_WIPEMOUTH
        SET_GCODE_VARIABLE MACRO=M600 VARIABLE=filament_change VALUE=0
        SET_GCODE_VARIABLE MACRO=M600 VARIABLE=stage VALUE=0
        RESTORE_GCODE_STATE NAME=M600_state MOVE=0
        BASE_RESUMEPRINT

    {% else %}
    # Normal (non-M600) resumes use your existing behavior
    BASE_RESUMEPRINT
    {% endif %}


